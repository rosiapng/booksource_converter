<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Deobfuscator</title>

    <!-- Load Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        let babelReady = false; // ✅ Track Babel loading state

        async function loadBabelModules() {
            try {
                const babelParserModule = await import("https://cdn.jsdelivr.net/npm/@babel/parser@7.21.4/+esm");
                const babelTraverseModule = await import("https://cdn.jsdelivr.net/npm/@babel/traverse@7.21.4/+esm");
                const babelGeneratorModule = await import("https://cdn.jsdelivr.net/npm/@babel/generator@7.21.4/+esm");

                // ✅ Assign modules correctly
                window.babelParser = babelParserModule;
                window.babelTraverse = babelTraverseModule.default; // FIX: Properly set traverse
                window.babelGenerator = babelGeneratorModule.default; // FIX: Properly set generator

                babelReady = true; // ✅ Mark Babel as ready
                document.getElementById("deobfuscateButton").disabled = false; // Enable button
            } catch (error) {
                console.error("Failed to load Babel modules:", error);
            }
        }

        loadBabelModules();
    </script>
</head>
<body>
    <h2>JavaScript Deobfuscator</h2>
    <textarea id="inputCode" rows="10" cols="50" placeholder="Paste obfuscated JavaScript here"></textarea>
    <br>
    <button id="deobfuscateButton" disabled>Deobfuscate</button>
    <h3>Deobfuscated Code:</h3>
    <pre id="outputCode"></pre>

    <script>
        async function waitForBabel() {
            while (!babelReady) {
                await new Promise(resolve => setTimeout(resolve, 50)); // ✅ Wait 50ms if Babel is not ready
            }
        }

        async function deobfuscate() {
            await waitForBabel(); // ✅ Ensure Babel is loaded before running

            try {
                const inputCode = document.getElementById("inputCode").value;
                if (!inputCode.trim()) {
                    document.getElementById("outputCode").textContent = "Error: No input code provided!";
                    return;
                }

                const ast = window.babelParser.parse(inputCode, {
                    sourceType: "script",
                    allowReturnOutsideFunction: true,
                    plugins: ["jsx"]
                });

                // ✅ Traverse AST to remove dead code
                window.babelTraverse(ast, {
                    VariableDeclarator(path) {
                        const binding = path.scope.getBinding(path.node.id.name);
                        if (binding && binding.references === 0) {
                            path.remove();
                        }
                    },
                    IfStatement(path) {
                        if (path.node.test.type === "BooleanLiteral" && !path.node.test.value) {
                            path.remove();
                        }
                    },
                    ExpressionStatement(path) {
                        if (path.node.expression.type === "NumericLiteral" || path.node.expression.type === "StringLiteral") {
                            path.remove();
                        }
                    }
                });

                // ✅ Generate cleaned code
                const output = window.babelGenerator(ast, { retainLines: true }).code;
                document.getElementById("outputCode").textContent = output || "No changes detected.";
            } catch (err) {
                document.getElementById("outputCode").textContent = "Error: " + err.message;
            }
        }

        document.getElementById("deobfuscateButton").addEventListener("click", deobfuscate);
    </script>
</body>
</html>
